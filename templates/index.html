<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Rechnungsverarbeitung - Multi-PDF Batch System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #0056b3;
            background: #e3f2fd;
        }
        .upload-area i {
            font-size: 3rem;
            color: #007bff;
            margin-bottom: 20px;
        }
        .batch-controls {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .processed-files {
            background: #d1ecf1;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .file-item {
            background: white;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-file-pdf text-danger"></i>
                    PDF Rechnungsverarbeitung
                    <small class="text-muted d-block">Multi-PDF Batch Processing</small>
                </h1>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Upload Area -->
        <div class="row">
            <div class="col-12">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>PDF-Dateien hochladen</h4>
                    <p class="text-muted">Klicken Sie hier oder ziehen Sie PDF-Dateien hierher</p>
                    <p class="text-info"><strong>Neu:</strong> Mehrere PDFs gleichzeitig ausw√§hlen f√ºr Batch-Verarbeitung!</p>
                    <input type="file" id="fileInput" accept=".pdf" multiple style="display: none;">
                </div>
            </div>
        </div>

        <!-- Batch Controls -->
        <div class="batch-controls" id="batchControls" style="display: none;">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="batchProcessing" checked>
                        <label class="form-check-label" for="batchProcessing">
                            <strong>Batch-Verarbeitung aktiviert</strong>
                        </label>
                        <small class="d-block text-muted">Alle ausgew√§hlten Dateien automatisch verarbeiten</small>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-outline-warning btn-sm" id="clearAllBtn" onclick="clearAllProcessedFiles()">
                        <i class="fas fa-trash"></i> Alle l√∂schen
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Container -->
        <div id="progressContainer" style="display: none;" class="my-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span id="currentFileName">Verarbeitung l√§uft...</span>
                <span id="progressText">0%</span>
            </div>
            <div class="progress">
                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
            </div>
        </div>

        <!-- Processed Files Section -->
        <div class="processed-files" id="processedFilesSection" style="display: none;">
            <h5>
                <i class="fas fa-check-circle text-success"></i>
                Verarbeitete Dateien (<span id="fileCount">0</span>)
            </h5>
            <div id="processedFilesList" class="mt-3"></div>
            <div class="mt-3">
                <button class="btn btn-success me-2" onclick="exportBatchData('excel')">
                    <i class="fas fa-file-excel"></i> Alle als Excel exportieren
                </button>
                <button class="btn btn-outline-success" onclick="exportBatchData('csv')">
                    <i class="fas fa-file-csv"></i> Alle als CSV exportieren
                </button>
            </div>
        </div>

        <!-- Results Section (f√ºr einzelne Datei-Details) -->
        <div id="resultsSection" style="display: none;" class="mt-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-info"></i>
                        Extrahierte Daten
                    </h5>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="exportData('excel')">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportData('csv')">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Lieferant</label>
                                <input type="text" class="form-control" id="field_supplier" onchange="updateField('supplier')">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Rechnungsnummer</label>
                                <input type="text" class="form-control" id="field_invoice_number" onchange="updateField('invoice_number')">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Datum</label>
                                <input type="text" class="form-control" id="field_date" onchange="updateField('date')">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Betrag</label>
                                <input type="text" class="form-control" id="field_amount" onchange="updateField('amount')">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">W√§hrung</label>
                                <input type="text" class="form-control" id="field_currency" onchange="updateField('currency')">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Beschreibung</label>
                                <input type="text" class="form-control" id="field_description" onchange="updateField('description')">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KI Training Link -->
        <div class="text-center mt-4">
            <a href="/training" class="btn btn-outline-primary">
                <i class="fas fa-brain"></i> KI-Training Dashboard
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const batchControls = document.getElementById('batchControls');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const currentFileName = document.getElementById('currentFileName');
        const processedFilesSection = document.getElementById('processedFilesSection');
        const processedFilesList = document.getElementById('processedFilesList');
        const fileCount = document.getElementById('fileCount');
        const resultsSection = document.getElementById('resultsSection');
        const alertContainer = document.getElementById('alertContainer');

        // Global Variables
        let processedFiles = [];
        let currentFileIndex = 0;
        let isProcessing = false;
        let currentPdfData = null;

        // Event Listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
            }
        });

        // Main File Handling Function
        function handleFiles(files) {
            const pdfFiles = Array.from(files).filter(file => file.type === 'application/pdf');
            
            if (pdfFiles.length === 0) {
                showAlert('Keine PDF-Dateien gefunden!', 'warning');
                return;
            }
            
            if (pdfFiles.length !== files.length) {
                showAlert(`${files.length - pdfFiles.length} Nicht-PDF-Dateien ignoriert`, 'warning');
            }

            // Show batch controls if multiple files
            if (pdfFiles.length > 1) {
                batchControls.style.display = 'block';
            }

            const batchProcessing = document.getElementById('batchProcessing').checked;
            
            if (batchProcessing && pdfFiles.length > 1) {
                processBatchFiles(pdfFiles);
            } else {
                // Single file processing
                uploadSingleFile(pdfFiles[0]);
            }
        }

        // Batch Processing Functions
        function processBatchFiles(files) {
            if (isProcessing) {
                showAlert('Verarbeitung l√§uft bereits!', 'warning');
                return;
            }

            isProcessing = true;
            currentFileIndex = 0;
            
            showAlert(`Starte Batch-Verarbeitung von ${files.length} Dateien...`, 'info');
            progressContainer.style.display = 'block';
            
            processNextFile(files);
        }

        function processNextFile(files) {
            if (currentFileIndex >= files.length) {
                // All files processed
                isProcessing = false;
                progressContainer.style.display = 'none';
                showAlert(`‚úÖ Batch-Verarbeitung abgeschlossen! ${processedFiles.length} Dateien verarbeitet.`, 'success');
                updateProcessedFilesList();
                
                // Zeige Daten der letzten verarbeiteten Datei
                if (processedFiles.length > 0) {
                    const lastFile = processedFiles[processedFiles.length - 1];
                    currentPdfData = lastFile;
                    showResults(lastFile.data);
                }
                return;
            }

            const file = files[currentFileIndex];
            const progress = (currentFileIndex / files.length) * 100;
            progressBar.style.width = progress + '%';
            progressText.textContent = Math.round(progress) + '%';
            currentFileName.textContent = `Verarbeite: ${file.name} (${currentFileIndex + 1}/${files.length})`;
            
            uploadFileForBatch(file, files);
        }

        function uploadFileForBatch(file, allFiles) {
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Upload response:', data); // Debug-Log
                
                if (data.success) {
                    // F√ºge zu verarbeiteten Dateien hinzu
                    const processedFile = {
                        filename: file.name,
                        data: data.data,
                        raw_text: data.raw_text || '',
                        timestamp: new Date().toLocaleString('de-DE')
                    };
                    processedFiles.push(processedFile);
                    
                    console.log('Processing file data:', data.data); // Debug-Log
                    
                    // Zeige Daten der letzten verarbeiteten Datei in der Hauptansicht
                    currentPdfData = processedFile;
                    showResults(data.data);
                    
                    showAlert(`‚úÖ ${file.name} erfolgreich verarbeitet`, 'success');
                } else {
                    showAlert(`‚ùå Fehler bei ${file.name}: ${data.error}`, 'danger');
                }
                
                currentFileIndex++;
                setTimeout(() => processNextFile(allFiles), 500);
            })
            .catch(error => {
                console.error('Fehler:', error);
                showAlert(`‚ùå Fehler bei ${file.name}: ${error.message}`, 'danger');
                currentFileIndex++;
                setTimeout(() => processNextFile(allFiles), 500);
            });
        }

        // Single File Processing
        function uploadSingleFile(file) {
            if (isProcessing) {
                showAlert('Verarbeitung l√§uft bereits!', 'warning');
                return;
            }

            isProcessing = true;
            progressContainer.style.display = 'block';
            progressBar.style.width = '50%';
            currentFileName.textContent = `Verarbeite: ${file.name}`;

            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Single file upload response:', data); // Debug-Log
                
                isProcessing = false;
                progressContainer.style.display = 'none';

                if (data.success) {
                    currentPdfData = {
                        filename: file.name,
                        data: data.data,
                        raw_text: data.raw_text || ''
                    };
                    
                    console.log('Single file data:', data.data); // Debug-Log
                    showResults(data.data);
                    showAlert('‚úÖ PDF erfolgreich verarbeitet!', 'success');
                } else {
                    showAlert('‚ùå Fehler: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                isProcessing = false;
                progressContainer.style.display = 'none';
                console.error('Fehler:', error);
                showAlert('‚ùå Fehler beim Upload: ' + error.message, 'danger');
            });
        }

        // UI Update Functions
        function updateProcessedFilesList() {
            processedFilesList.innerHTML = '';
            
            processedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item d-flex justify-content-between align-items-center';
                
                fileItem.innerHTML = `
                    <div>
                        <strong>${file.filename}</strong>
                        <small class="text-muted d-block">Verarbeitet: ${file.timestamp}</small>
                        <small class="text-info">
                            Lieferant: ${file.data.supplier || 'N/A'} | 
                            Betrag: ${file.data.amount || 'N/A'} ${file.data.currency || ''}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewFileDetails(${index})">
                            <i class="fas fa-eye"></i> Anzeigen
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeProcessedFile(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                processedFilesList.appendChild(fileItem);
            });
            
            fileCount.textContent = processedFiles.length;
            
            if (processedFiles.length > 0) {
                processedFilesSection.style.display = 'block';
            }
        }

        function showResults(data) {
            console.log('Showing results with data:', data); // Debug-Log
            
            if (!data) {
                console.error('Keine Daten erhalten!');
                showAlert('‚ùå Keine Daten empfangen', 'danger');
                return;
            }
            
            document.getElementById('field_supplier').value = data.supplier || '';
            document.getElementById('field_invoice_number').value = data.invoice_number || '';
            document.getElementById('field_date').value = data.date || '';
            document.getElementById('field_amount').value = data.amount || '';
            document.getElementById('field_currency').value = data.currency || '';
            document.getElementById('field_description').value = data.description || '';
            
            resultsSection.style.display = 'block';
            
            // Debug-Information anzeigen
            showAlert(`üìä Daten angezeigt: Lieferant: ${data.supplier || 'N/A'}, Betrag: ${data.amount || 'N/A'}`, 'info');
        }

        // Processed Files Management
        function viewFileDetails(index) {
            const file = processedFiles[index];
            if (!file) return;
            
            currentPdfData = file;
            showResults(file.data);
            showAlert(`Details f√ºr ${file.filename} angezeigt`, 'info');
        }

        function removeProcessedFile(index) {
            if (confirm(`M√∂chten Sie ${processedFiles[index].filename} aus der Liste entfernen?`)) {
                processedFiles.splice(index, 1);
                updateProcessedFilesList();
                showAlert('Datei aus Liste entfernt', 'info');
                
                if (processedFiles.length === 0) {
                    processedFilesSection.style.display = 'none';
                }
            }
        }

        function clearAllProcessedFiles() {
            if (processedFiles.length === 0) return;
            
            if (confirm(`M√∂chten Sie alle ${processedFiles.length} verarbeiteten Dateien aus der Liste entfernen?`)) {
                processedFiles = [];
                processedFilesSection.style.display = 'none';
                showAlert('Alle Dateien aus Liste entfernt', 'info');
            }
        }

        // Export Functions
        function exportData(format) {
            window.open(`/export/${format}`, '_blank');
        }

        function exportBatchData(format) {
            if (processedFiles.length === 0) {
                showAlert('Keine verarbeiteten Dateien zum Exportieren vorhanden', 'warning');
                return;
            }
            
            const batchData = processedFiles.map(file => ({
                filename: file.filename,
                timestamp: file.timestamp,
                ...file.data
            }));
            
            fetch('/export/batch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    format: format,
                    data: batchData
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Export fehlgeschlagen');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `batch_export_${processedFiles.length}_files.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert(`${processedFiles.length} Dateien als ${format.toUpperCase()} exportiert`, 'success');
            })
            .catch(error => {
                console.error('Export error:', error);
                showAlert('Fehler beim Batch-Export', 'danger');
            });
        }

        // Utility Functions
        function updateField(fieldName) {
            const input = document.getElementById(`field_${fieldName}`);
            showAlert(`${fieldName} aktualisiert: ${input.value}`, 'info');
            
            if (currentPdfData) {
                saveTrainingData();
            }
        }

        function saveTrainingData() {
            if (!currentPdfData) return;
            
            const correctedData = {};
            const fields = ['supplier', 'invoice_number', 'date', 'amount', 'currency', 'description'];
            
            fields.forEach(field => {
                const input = document.getElementById(`field_${field}`);
                if (input) {
                    correctedData[field] = input.value;
                }
            });
            
            fetch('/api/training/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    raw_text: currentPdfData.raw_text || '',
                    corrected_data: correctedData,
                    filename: currentPdfData.filename || ''
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Trainingsdaten automatisch gespeichert');
                }
            })
            .catch(error => {
                console.error('Fehler beim Speichern der Trainingsdaten:', error);
            });
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>